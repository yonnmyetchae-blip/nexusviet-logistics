<script>
document.getElementById("shipmentForm").onsubmit = async function(e) {
    e.preventDefault();

    // Read all values safely
    const senderName     = document.getElementById("Sender_Name").value.trim();
    const senderPhone    = document.getElementById("Sender_Phone").value.trim();
    const receiverName   = document.getElementById("Receiver_Name").value.trim();
    const receiverPhone  = document.getElementById("Receiver_Phone").value.trim();
    const receiverAddr   = document.getElementById("Receiver_Address").value.trim();
    const route          = document.getElementById("route").value;
    const flightDate     = document.getElementById("flight").value;
    const itemDesc       = document.getElementById("item").value.trim();
    const quantity       = Number(document.getElementById("quantity").value) || 0;
    const handlingPerPkg = Number(document.getElementById("handling_fee_mmk").value) || 0;
    const weightKg       = Number(document.getElementById("weight").value) || 0;
    const rateMMK        = Number(document.getElementById("rateMMK").value) || 0;
    const rateVND        = Number(document.getElementById("rateVND").value) || 0;
    const status         = document.getElementById("Status").value;
    const remarks        = document.getElementById("Remarks").value.trim();

    // Basic validation (optional but recommended)
    if (!senderName || !receiverName || quantity <= 0 || weightKg <= 0) {
        alert("Please fill required fields (sender, receiver, quantity, weight)");
        return;
    }

    const tracking = "NXS-" + Date.now();
    const invoice  = "INV-" + new Date().getFullYear() + "-" + String(Math.floor(Math.random() * 10000)).padStart(4, '0');

    const handlingTotal = quantity * handlingPerPkg;
    const freightMMK    = weightKg * rateMMK;
    const freightVND    = weightKg * rateVND;
    const totalMMK      = handlingTotal + freightMMK;
    const totalVND      = freightVND;   // adjust logic if you want handling in VND too

    const payload = {
        tracking_no:     tracking,
        invoice_no:      invoice,
        sender_name:     senderName,
        sender_phone:    senderPhone,
        receiver_name:   receiverName,
        receiver_phone:  receiverPhone,
        receiver_address: receiverAddr,
        route:           route,
        flight_date:     flightDate,
        item_desc:       itemDesc,
        quantity:        quantity,
        handling_fee_mmk: handlingPerPkg,
        weight_kg:       weightKg,
        rate_per_kg_mmk: rateMMK,
        rate_per_kg_vnd: rateVND,
        subtotal_mmk:    freightMMK,      // or adjust field names
        total_mmk:       totalMMK,
        total_vnd:       totalVND,
        status:          status,
        remarks:         remarks
    };

    try {
        const response = await fetch(
            "https://script.google.com/macros/s/AKfycbwoyNzupluztEPyAKdm7jhu8RA-VZkBZ-dBb9Iyu6gDK0oEn_6DMrJgg5SQ6_GA_0wk/exec",
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }
        );

        if (!response.ok) throw new Error("Save failed");

        // Open invoice in new tab/window
        window.open(
            `invoice.html?tracking=${encodeURIComponent(tracking)}&invoice=${encodeURIComponent(invoice)}&mmk=${totalMMK}&vnd=${totalVND}`,
            "_blank"
        );

    } catch (err) {
        console.error(err);
        alert("Error saving shipment: " + err.message);
    }
};
</script>
