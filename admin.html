<!DOCTYPE html>
<html>
<head>
  <title>Nexus Admin – Create Shipment</title>
</head>
<body>

<h2>Create Shipment</h2>

<form id="shipmentForm">
  Sender Name: <input required id="sender"><br>
  Sender Phone: <input id="phone"><br>
  Receiver Information: <input required id="receiver"><br>

  Route:
  <select id="route">
    <option>YGN – HCM</option>
    <option>YGN – Hanoi</option>
    <option>YGN – DaNang</option>
    <option>HCM – YGN</option>
    <option>Hanoi – YGN</option>
    <option>DaNang – YGN</option>
  </select><br>

  Flight Date: <input type="date" id="flight"><br>
  Item Description: <input id="item"><br>

  Quantity: <input type="number" id="quantity" value="1"><br>
  Handling fee (MMK): <input type="number" id="handling" value="0"><br>

  Weight (KG): <input type="number" id="weight" value="1"><br>
  Rate per KG MMK: <input type="number" id="rateMMK" value="0"><br>

  <button type="submit">Generate Invoice</button>
</form>

<script>
document.getElementById("shipmentForm").onsubmit = async function(e) {
  e.preventDefault();

  // 1. Generate IDs
  const tracking = "NXS-" + Date.now();
  const invoice = "INV-" + new Date().getFullYear() + "-" + Math.floor(Math.random() * 1000);

  // 2. Read values safely
  const qty = Number(document.getElementById("quantity").value);
  const handlingFee = Number(document.getElementById("handling").value);
  const weightKg = Number(document.getElementById("weight").value);
  const rateMMK = Number(document.getElementById("rateMMK").value);

  // 3. Calculate totals
  const totalMMK = (qty * handlingFee) + (weightKg * rateMMK);
  const totalVND = 0;

  // 4. Build payload
  const payload = {
    tracking_no: tracking,
    invoice_no: invoice,
    sender_name: document.getElementById("sender").value,
    sender_phone: document.getElementById("phone").value,
    receiver_info: document.getElementById("receiver").value,
    route: document.getElementById("route").value,
    flight_date: document.getElementById("flight").value,
    item_desc: document.getElementById("item").value,
    quantity: qty,
    handling_fee_mmk: handlingFee,
    weight_kg: weightKg,
    rate_mmk: rateMMK,
    total_mmk: totalMMK,
    total_vnd: totalVND,
    status: "Received",
    remarks: ""
  };

  try {
    // 5. Send to Apps Script
    const res = await fetch(
      "https://script.google.com/macros/s/AKfycbwoyNzupluztEPyAKdm7jhu8RA-VZkBZ-dBb9Iyu6gDK0oEn_6DMrJgg5SQ6_GA_0wk/exec",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      }
    );

    // 6. Open invoice popup
    window.open(
      `invoice.html?tracking=${tracking}&invoice=${invoice}&mmk=${totalMMK}&vnd=${totalVND}`,
      "_blank"
    );

  } catch (err) {
    alert("Error sending data: " + err.message);
  }
};
</script>

</body>
</html>
